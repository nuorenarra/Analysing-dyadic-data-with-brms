# Analysing-dyadic-data-with-brms
Bayesian multimembership glm framework for modeling pairwise (dyadic) values
(c) Aura Raulo 2022

# In short

In biology and social sciences, many measures/variables of interest are inherently on the scale of pairs of individuals/samples, such as genetic distance, social association (e.g. Simple ratio Index), spatial or temporal distance (e.g. distance in meters of hours) or overlap (e.g home range overlap, life span overlap), or similarity in some proportional (e.g. microbiome dissimilarity) or categorical attribute (e.g. similarity in sex). Pairwise measurements often contain more informative variation than individual/sample -level summary measurements (e.g. categorical "genotype" rather than genetic distance, or "site" rathe than spatial distance) making them a good way to increase powere of statistical inference, but these values are not statistically speaking independent values, so they cannot be modelled as such.
 
To construct a multivariate model predicting dyadic (pairwise) values with other pairwise values you can take for example two routes: Null-model approach (matrix permutation models) or dyadic glm with multimembership random effect structure. The former is using the dependence structure of the data itself as a null model so you won't need to know much about it, just see whether the correlation between two matrices is more extreme than the distribution of correlation coefficients of the same two matrices when the other one is randomized multiple times and correlation re-calculated each time. The second one is a generalized linear mixed model approach, that aims at accounting for the specific type of dependence introduced by pairwise comparisons with multimembership random effect structure. This approach is  more flexible in that it can accommodate a variety of different response variable types (proportions, counts etc...) with different distributions (skewed, normal), and it can deal with interaction effects and repeated measurements of same individual (nested/hierarchical autocorrelation) alongside the dyadic dependence of the values (multimembership autocorrelation). 

This tutorial focuses on the latter case, introducing modeling pairwise data using a Bayesian multimembership glm framework using the Bayesian regression R package brms (Buerkner 2017). As and example, we will use a real data set on wild mouse microbiome with known correlation patterns among dyadic variables (See Raulo et al., 2021). We will explore a research question:
"Does social association strength ("social transmission link") and spatial overlap ("environmental transmission link") predict gut microbiome similarity between pairs of wild mice?" 


The codes walk you through the steps of 
(1) making pairwise dataframes, 
(2) building dyadic models in brms, (here, predicting overall microbiome similarity with social associations and spatial overlap among pairs of mice)  

Coming soon:
(3) building a post hoc drop-model to deconstruct the whole-microbiome-level transmission effects into the level of microbial taxa (genera) to test which bacteria seem to be transmitted through space and which through social association



# General introduction to statistical modeling of dyadic values

A central assumption of statistical modeling is that datapoints are independent. This means that the value of one observation is not influenced by the value of another observation. Failing to account for non-independence can result in pseudoreplication, which increases the rate of false positive results in statistical analyses (Hurlbert 1984). In natural systems, however, measurements are rarely truly independent and in fact a lot of the important variation is tied to the very connections and interactions between things. Consequently, a range of methods have been developed to account for non-independence of response values. A common example is the use of random factors used in multivariate models, to account for nested similarity structures in the data, such as repeated measurements from the same sites. Here, “dependence” between measurements means that we would expect them to be inherently more similar within sites than between sites, and by taking this into account, we can assess other important drivers of this variation. But if this site-similarity is due to geographic patterns in the values, then perhaps sites closer to each other might also be more similar to one another than sites further apart? Sometimes forcing values into categories (e.g. “site”) is suboptimal compared to modeling their interdependence on a more continuous scale (e.g. “distance between sites”). Furthermore, not all dependencies present in biological data can be simplified by forcing their variation into separate categories in the first place. For example, genetic relationships, social associations or ecological community composition are difficult to represent as discrete groups, as their variation is inherently continuous, and can be fully revealed only by considering pairwise comparisons (e.g. genetic distance, social association strength, community similarity).

Pairwise (“dyadic”) values are by definition not independent of each other. For instance, multiple values of distance end up at the same point, and
 many social relationships contain the same individual. This dependence structure does not involve datapoints simply falling into a nested a hierarchy of groups, as not only do individuals have many relationships, but all relationships belong to at least two individuals. This kind of dependence structure across pairwise values is best understood as a network where pairwise values are edges connecting a set of nodes (e.g. individuals). The power  of the network analogy is that it allows one to capture how even pairwise values that do not involve the same node still have indirect dependence on each other through other nodes and edges. In fact, the strength of autocorrelation between pairwise values degrades with increasing number of steps (nodes) between values. Using the words of network scientists, the dependence between edges degrades with distance in a fully connected network. 

How do these correlational networks influence statistical power? Even though pairwise values are all dependent on each other and thus carry less information than the same number of independent values, they still carry more information than can be expressed by nodes alone. For instance, distances between five locations add up to 10 pairwise values, which contain less information than would 10 independent values but still more than the information contained by the 5 independent nodes. Thus, modeling pairwise data is an important way of using all available information in a data set and maximizing statistical power. Consequently, many research fields such as genetics, social network analysis, evolutionary ecology and spatial and community ecology have developed statistical tools to effectively deal with pairwise correlation structures. Curiously, the development of these methods across research disciplines has happened somewhat independently, creating statistical subcultures within fields. For example, a popular method in quantitative genetics, the “animal model” specifies a genetic structure within a population as an inverse relatedness matrix within a multivariate model, to partition variation in a host trait of interest to that explained by relatedness compared to other (environmental) influences (Kruuk, 2004; see also Thomson et al., 2018 for other types of distance matrices). In spatial ecology, multiple linear modeling approaches have similarly been developed to explicitly account for spatial autocorrelation in the residuals of species distributions across locations (Dormann et al., 2007). In community ecology, pairwise measures of community similarity are commonly predicted with node-level attributes using permutational multivariate analysis of variance (“PERMANOVA”), a statistical test that partitions variation in a pairwise distance matrix across node-level variables and infers statistical significance by randomly permuting the distance matrix to create null models with no real correlations but a similar dependence structure (Anderson, 2017). 

A lot of these tools have been developed in order to account for pairwise dependence structures in the data while statistically modeling values attached to the nodes. However, microbiota research has created a need for a new kind of pairwise model. This is because, as stated above, variation in microbiotas is best described by pairwise indices of distance or dissimilarity, which can be influenced both by node-level variables (e.g. host attributes) but also processes that happen between hosts, such as transmission of bacteria from one host to another, or exposure to more or less similar environments. Thus, drivers of microbiota variation are not optimally modelled by predicting a pairwise response with node-level predictors (as in PERMANOVA) nor a node-level variable predicted by pairwise matrices (as in the animal model). Microbiota research thus serves as a motivation to develop fully dyadic models, capable of modelling pairwise values (e.g. community distance metrics) with pairwise predictors. Various methods have been explored for predicting microbiota dissimilarity metrics, or similar measures of degree of microbe sharing. These include multiple regression quadratic assignment procedure or “MRQAP” (Amato et al., 2017; VanderWaal et al., 2014), generalized dissimilarity models or “GDMs” (Fountain‐Jones et al., 2017), graphical network models (Fountain-Jones et al., 2019),  Integrated nested Laplace approximation, or “INLA”: (Gayawan et al., 2020) and regression with multi-membership random effects (Blyton et al., 2014; Springer et al., 2016). These approaches generally apply one of two alternative statistical strategies, with the network-like autocorrelation in the data accounted for by either 1) using null model permutations or 2) specifying a random dependence structure within the model. Here, I’ll describe one of each method types, a pair of models that I find most promising and which are subsequently used in this thesis: Multiple regression quadratic assignment procedure (“MRQAP”) and Bayesian regression using multi-membership random effects (“dyadic Bayesian regression”).

# MRQAP
MRQAP is a matrix correlation model, similar to a Mantel test, but with multiple predictor matrices predicting one response matrix (Dekker et al., 2007). MRQAP has been long used to correlate pairwise values among social network scientists (Dekker et al., 2007) and has become a commonly used method for linking contact networks with transmission of microbes (pathogenic: VanderWaal et al., 2014, or mutualistic:

Amato et al., 2017, sharing of information in real life social networks or social media (Cvetojevic & Hochmair, 2021; Holvoet et al., 2016) or sharing of resources, such as food among humans and other social animals (Carter et al., 2019; Koster, 2011). MRQAP deals with interdependence among datapoints by using null model permutations. The correlations among pairwise values across matrices are estimated as in a normal multivariate model, but to assess their significance, these coefficients are then compared to a set of coefficients derived from null models that use randomly shuffled versions of the response variable matrix. In other words, this procedure compares the observed covariation between pairwise values to covariation expected to arise from the network structure alone, i.e. correlations between pairwise values when any real signal is broken by shuffling, but the autocorrelation structure among datapoints is retained. Controlling the random shuffling process allows different types of inference. For instance, randomizing the residuals from regression on each predictor matrix instead of the response matrix, allows sequential testing of the effects (the effect of predictor 1 on response controlled against the effect of predictor 2;  Dekker et al., 2007). The main limitation of MRQAP is its sensitivity to skewed response value distributions (e.g negative binomial distributions) and the lack of accounting for nested (hierarchical) autocorrelation across data (e.g. repeated samples from the same individuals).

# Dyadic Bayesian regression
Modeling pairwise values in a multivariate generalized linear model framework is made possible by specifying a non-nested, multi-membership random effect (Browne et al., 2001). This random effect resembles the common nested random factor, but in addition to hierarchical structure, each pairwise value is given membership of multiple (here exactly two) groups, which represent the independent nodes attached to each pairwise comparison. For example, in the simplest case, the model formula would be:
y_AB~x_AB+mm(A+B),

where response variable y and predictor x are both pairwise comparisons between independent nodes A and B, and the last term specifies a random intercept across a multi-membership of nodes A and B.

This simple trick informs the model not only of the fact that some values have the common attribute that they, in network terms, connect to the same node, but moreover it lets the pairwise values not connecting to the same node depend on each other indirectly. After specifying the multi-membership random effect, pairwise values can be modeled as if they are independent measurements. This kind of dyadic regression was originally suggested by (Browne et al., 2001), utilized as a method to predict microbial sharing by (Blyton et al., 2014) and further developed by me in this thesis (Chapter 2, published as Raulo et. al 2021). Specifically, I extended this method to work in a Bayesian regression framework using the R package brms, allowing dyadic beta-regression of proportional data (such as microbiota data) while estimating the full posterior distribution of the multi-membership random structure alongside the predictor effects. Comparing results from this updated dyadic Bayesian regression model to MRQAP yielded very similar results (see Chapter 2, Supplementary Appendix S5), but unlike MRQAP, this method can also account for nested dependence structures and provides more flexibility over response distributions.


As a final note, let it be said that these methods have been developed to account for the autocorrelation inherent for any type of pairwise comparison. However, just like many other metrics, different types of pairwise values have different features that come with varying autocorrelation structures. One simple example considers different types of distances: measures of Euclidean distances, such as real metric distance, are dependent on each other in a slightly different way than non-Euclidean distances. For instance, if you are standing on a two-dimensional space of Euclidean distance (e.g. football field), moving towards any point will affect your distance to all other points on the plain. But were you to stand on a field of non-Euclidean distances, e.g. a space describing similarity between ecological communities, you can become more similar to one other community while staying just as similar to another. Thus, in some ways, non-Euclidean distances are more independent of each other than Euclidean distances are. To date, I am not aware of any statistical methods differentiating between the autocorrelation structures of different types of distance values and future research is needed to assess how important these differences may be for dyadic modelling


## References
Amato, K. R., van Belle, S., di Fiore, A., Estrada, A., Stumpf, R., White, B., Nelson, K. E., Knight, R., & Leigh, S. R. (2017). Patterns in Gut Microbiota Similarity Associated with Degree of Sociality among Sex Classes of a Neotropical Primate. Microbial Ecology, 74(1), 250–258. https://doi.org/10.1007/s00248-017-0938-6

Anderson, M. J. (2017). Permutational Multivariate Analysis of Variance ( <scp>PERMANOVA</scp> ). In Wiley StatsRef: Statistics Reference Online (pp. 1–15). Wiley. https://doi.org/10.1002/9781118445112.stat07841

Blyton, M. D. J., Banks, S. C., Peakall, R., Lindenmayer, D. B., & Gordon, D. M. (2014). Not all types of host contacts are equal when it comes to E. coli transmission. Ecology Letters, 17(8), 970–978. https://doi.org/10.1111/ele.12300

Browne, W. J., Goldstein, H., & Rasbash, J. (2001). Multiple membership multiple classification (MMMC) models. Statistical Modelling, 1(2), 103–124. https://doi.org/10.1177/1471082X0100100202

Carter, G., Farine, D., Crisp, R., Vrtilek, J., Ripperger, S., & Page, R. (2019). Development of new food-sharing relationships among nonkin vampire bats. BioRxiv, 534321. https://doi.org/10.1101/534321

Cvetojevic, S., & Hochmair, H. H. (2021). Modeling interurban mentioning relationships in the U.S. Twitter network using geo-hashtags. Computers, Environment and Urban Systems, 87, 101621. https://doi.org/10.1016/j.compenvurbsys.2021.101621

Dekker, D., Krackhardt, D., Psychometrika, T. S.-, & 2007, undefined. (n.d.). Sensitivity of MRQAP tests to collinearity and autocorrelation conditions. Springer. Retrieved July 30, 2020, from https://link.springer.com/content/pdf/10.1007/s11336-007-9016-1.pdf

F. Dormann, C., M. McPherson, J., B. Araújo, M., Bivand, R., Bolliger, J., Carl, G., G. Davies, R., Hirzel, A., Jetz, W., Daniel Kissling, W., Kühn, I., Ohlemüller, R., R. Peres-Neto, P., Reineking, B., Schröder, B., M. Schurr, F., & Wilson, R. (2007). Methods to account for spatial autocorrelation in the analysis of species distributional data: a review. Ecography, 30(5), 609–628. https://doi.org/10.1111/j.2007.0906-7590.05171.x

Fountain-Jones, N. M., Clark, N., Kinsley, A., Carstensen, M., Forrester, J., Johnson, T. J., Miller, E., Moore, S., Wolf, T., & Craft, M. (2019). Microbial associations and spatial proximity predict North American moose (Alces alces) gastrointestinal community composition. BioRxiv, 514604. https://doi.org/10.1101/514604

Fountain‐Jones, N. M., Packer, C., Troyer, J. L., VanderWaal, K., Robinson, S., Jacquot, M., & Craft, M. E. (2017). Linking social and spatial networks to viral community phylogenetics reveals subtype‐specific transmission dynamics in African lions. Journal of Animal Ecology, 86(6), 1469–1482. https://doi.org/10.1111/1365-2656.12751

Gayawan, E., Adegboye, O. A., James, A., Adegboye, A. M., & Elfaki, F. (2020). Bayesian spatial modelling of outbreaks of Ebola in Democratic Republic of Congo through the INLA-SPDE approach. MedRxiv, 2020.04.13.20063081. https://doi.org/10.1101/2020.04.13.20063081

Holvoet, N., Dewachter, S., & Molenaers, N. (2016). Look Who’s Talking. Explaining Water-Related Information Sharing and Demand for Action Among Ugandan Villagers. Environmental Management, 58(5), 780–796. https://doi.org/10.1007/s00267-016-0760-9

Koster, J. (2011). Interhousehold Meat Sharing among Mayangna and Miskito Horticulturalists in Nicaragua. Human Nature, 22(4), 394–415. https://doi.org/10.1007/s12110-011-9126-4

Kruuk, L. E. B. (2004). Estimating genetic parameters in natural populations using the “animal model.” In Philosophical Transactions of the Royal Society B: Biological Sciences (Vol. 359, Issue 1446, pp. 873–890). Royal Society. https://doi.org/10.1098/rstb.2003.1437

Springer, A., Mellmann, A., Fichtel, C., & Kappeler, P. M. (2016). Social structure and Escherichia coli sharing in a group-living wild primate, Verreaux’s sifaka. BMC Ecology, 16(1), 6. https://doi.org/10.1186/s12898-016-0059-y

Thomson, C. E., Winney, I. S., Salles, O. C., & Pujol, B. (2018). A guide to using a Multiple-Matrix animal model to disentangle genetic and nongenetic causes of phenotypic variance. PLoS ONE, 13(10), e0197720. https://doi.org/10.1371/journal.pone.0197720

VanderWaal, K. L., Atwill, E. R., Isbell, Lynne. A., & McCowan, B. (2014). Linking social and pathogen transmission networks using microbial genetics in giraffe ( Giraffa camelopardalis ). Journal of Animal Ecology, 83(2), 406–414. https://doi.org/10.1111/1365-2656.12137
 

